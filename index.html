<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="static/favicon.ico" />
  <title>Text to Speak</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: linear-gradient(to bottom, #fef6fb, #fce4ec);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    .tts-card {
      background-color: #fff0f5;
      padding: 15px 25px;
      border-radius: 2rem;
      width: 95vw;
      height: 90vh;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 3px solid #ffb6c1;
      box-sizing: border-box;
      position: relative;
    }
    .tts-card h2 {
      font-size: 2rem;
      color: #ff4081;
      text-align: center;
      margin-bottom: 1rem;
    }
    .tts-selectors {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .tts-selectors select {
      font-size: 1rem;
      padding: 0.5rem 0.75rem;
      border-radius: 1rem;
      background-color: #fff8f9;
      border: 2px solid #ffc1e3;
    }
    textarea#ttsInput {
      width: 100%;
      padding: 1.2rem;
      border-radius: 1.2rem;
      font-size: 1.3rem;
      background-color: #fff;
      border: 2px solid #ffc1e3;
      resize: none;
      box-sizing: border-box;
      flex-grow: 1;
      min-height: 0;
      margin-bottom: 1rem;
    }
    .tts-buttons {
      display: flex;
      justify-content: center;
      gap: 1.2rem;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .tts-buttons button {
      padding: 0.7rem 1.6rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 1rem;
      cursor: pointer;
      background-color: #ffc4d6;
      color: #4d194d;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 120px;
    }
    .tts-buttons button:hover {
      background-color: #ff90b3;
    }
    .tts-buttons button img {
      height: 1.2rem;
    }
    #loadingStatus {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-style: italic;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.85);
      padding: 1rem 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      z-index: 999;
    }
    @media (max-width: 768px) {
      .tts-selectors, .tts-buttons {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="tts-card">
    <h2>üëß B√© T·∫≠p N√≥i</h2>
    <div class="tts-selectors">
      <select id="providerSelect"></select>
      <select id="languageSelect"></select>
      <select id="voiceSelect"></select>
      <select id="speedSelect">
        <option value="0.5">üê¢ R·∫•t ch·∫≠m</option>
        <option value="0.75">üê£ Ch·∫≠m</option>
        <option value="1.0" selected>üéµ B√¨nh th∆∞·ªùng</option>
        <option value="1.25">‚ú® H∆°i nhanh</option>
        <option value="1.5">üêá Nhanh</option>
        <option value="2">üöó R·∫•t nhanh</option>
      </select>
    </div>

    <textarea id="ttsInput" placeholder="üëß Nh·∫≠p n·ªôi dung b√© mu·ªën ƒë·ªçc nh√©...">Hello b√© y√™u! C√πng ƒë·ªçc n√†o!</textarea>

    <div class="tts-buttons">
      <button onclick="speakText()">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 10v4h4l5 5V5l-5 5H3zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03zm2.5 0c0 3.04-1.64 5.64-4.1 7.03l1.43 1.43C19.07 18.27 21 15.27 21 12s-1.93-6.27-5.17-8.46l-1.43 1.43C17.36 6.36 19 8.96 19 12z"/>
        </svg>
        N√≥i
      </button>
      <button onclick="togglePlayPause(this)" id="pauseBtn">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
        </svg>
        <span style="display:inline-block; width:88px">T·∫°m d·ª´ng</span>
      </button>
      <button onclick="downloadAudio()">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M5 20h14v-2H5v2zm7-18l-5.5 5.5h4v6h3v-6h4L12 2z"/>
        </svg>
        T·∫£i v·ªÅ
      </button>
    </div>

    <div id="loadingStatus">‚è≥ ƒêang t·∫£i gi·ªçng n√≥i...</div>
  </div>

  <script>
    const TTS_API = "https://voice-of-hope.onrender.com";
    let audio = null;
    let lastAudioUrl = null;
    const ttsCache = new Map();

    window.onload = loadVoices;

    async function loadVoices() {
      const loading = document.getElementById("loadingStatus");
      if (loading) loading.style.display = "inline";
      try {
        const res = await fetch(`${TTS_API}/api/voices`);
        const data = await res.json();
        const provider = data.default;
        const providers = data.providers;

        document.getElementById("providerSelect").innerHTML = Object.keys(providers).map(p =>
          `<option value="${p}" ${p === provider ? 'selected' : ''}>${p}</option>`
        ).join('');

        const langSelect = document.getElementById("languageSelect");
        const voiceSelect = document.getElementById("voiceSelect");
        langSelect.innerHTML = '';
        voiceSelect.innerHTML = '';

        const azureVoices = (providers.azure || []).filter(v =>
          ["en-US", "vi-VN"].includes(v.Locale));

        const langMap = {};
        azureVoices.forEach(v => {
          const lang = v.Locale;
          if (!langMap[lang]) langMap[lang] = [];
          langMap[lang].push(v);
        });

        for (const lang in langMap) {
          const langLabelMap = {
            "vi-VN": "Ti·∫øng Vi·ªát",
            "en-US": "Ti·∫øng Anh"
          };
          langSelect.innerHTML += `<option value="${lang}">${langLabelMap[lang] || lang}</option>`;
        }

        const updateVoices = () => {
          const selectedLang = langSelect.value;
          const voices = langMap[selectedLang] || [];
          voiceSelect.innerHTML = voices.map(v => {
            const val = v.ShortName;
            const label = v.DisplayName || val;
            return `<option value="${val}">${label}</option>`;
          }).join('');
        };

        langSelect.onchange = updateVoices;
        updateVoices();

      } catch (e) {
        alert("‚ùå L·ªói t·∫£i danh s√°ch voices.");
      } finally {
        if (loading) loading.style.display = "none";
      }
    }

    async function speakText() {
      const text = document.getElementById("ttsInput").value.trim();
      const provider = document.getElementById("providerSelect").value;
      const language = document.getElementById("languageSelect").value;
      const voice = document.getElementById("voiceSelect").value;
      const speed = parseFloat(document.getElementById("speedSelect").value);

      const cacheKey = JSON.stringify({ text, provider, language, voice });
      const cached = ttsCache.get(cacheKey);
      if (cached) return playFromCache(cached.audioUrl, cached.wordTimings, speed);

      const loading = document.getElementById("loadingStatus");
      if (loading) loading.style.display = "inline";

      try {
        const res = await fetch(`${TTS_API}/api/tts`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, provider, language, voice })
        });

        const contentType = res.headers.get("Content-Type");
        if (contentType.startsWith("multipart/mixed")) {
          const boundary = contentType.split("boundary=")[1];
          const buffer = await res.arrayBuffer();
          const { jsonData, audioBlob } = await parseMultipartMixedArrayBuffer(buffer, boundary);
          const wordTimings = jsonData.filter(w => w.type === "Word").map(w => ({
            word: w.text,
            start: w.offset / 1_000_000,
            end: (w.offset + w.duration) / 1_000_000
          }));
          const url = URL.createObjectURL(audioBlob);
          ttsCache.set(cacheKey, { audioUrl: url, wordTimings });
          playFromCache(url, wordTimings, speed);
        } else {
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          ttsCache.set(cacheKey, { audioUrl: url });
          playFromCache(url, null, speed);
        }
      } catch (e) {
        alert("‚ùå L·ªói x·ª≠ l√Ω audio.");
      } finally {
        if (loading) loading.style.display = "none";
      }
    }

    function parseMultipartMixedArrayBuffer(buffer, boundary) {
      const text = new TextDecoder().decode(buffer);
      const boundaryMarker = `--${boundary}`;
      const parts = text.split(boundaryMarker).filter(Boolean);
      let jsonPart = null;
      let audioStartIndex = -1;

      for (const part of parts) {
        if (part.includes("application/json")) {
          const jsonMatch = /\r\n\r\n([\s\S]+?)\r\n--/.exec(part + '--');
          if (jsonMatch) jsonPart = JSON.parse(jsonMatch[1]);
        }
        if (part.includes("audio/mpeg")) {
          const partOffset = text.indexOf(part);
          const bodyOffset = text.indexOf("\r\n\r\n", partOffset) + 4;
          const bodyText = text.slice(0, bodyOffset);
          audioStartIndex = bodyText.length;
        }
      }
      const audioBytes = buffer.slice(audioStartIndex);
      const audioBlob = new Blob([audioBytes], { type: 'audio/mpeg' });
      return { jsonData: jsonPart, audioBlob };
    }

    function estimateTimingsBySentence(text, duration) {
      const sentences = text.match(/[^.!?,;:‚Äì‚Äî]+[.!?,;:‚Äì‚Äî\s]*/g) || [text];
      const total = sentences.join('').length;
      let acc = 0;
      return sentences.map(s => {
        const start = acc / total * duration;
        acc += s.length;
        const end = acc / total * duration;
        return { text: s.trim(), start, end };
      });
    }

    function highlightBySentence(audio, timings) {
      const textarea = document.getElementById("ttsInput");
      const text = textarea.value;
      const sentences = text.match(/[^.!?,;:‚Äì‚Äî]+[.!?,;:‚Äì‚Äî\s]*/g) || [text];

      const render = () => {
        const t = audio.currentTime;
        const idx = timings.findIndex((w, i) => t >= w.start && t < w.end);
        if (idx !== -1) {
          let start = 0;
          for (let i = 0; i < idx; i++) start += sentences[i].length;
          const end = start + sentences[idx].length;
          textarea.focus();
          textarea.setSelectionRange(start, end);
        }
        if (!audio.paused && !audio.ended) requestAnimationFrame(render);
      };
      audio.onplay = () => requestAnimationFrame(render);
    }

    function playFromCache(audioUrl, timings, speed) {
      lastAudioUrl = audioUrl;
      if (audio) audio.pause();
      audio = new Audio(audioUrl);
      audio.playbackRate = speed;

      const text = document.getElementById("ttsInput").value.trim();

      if (timings && timings.length > 0) {
        highlightWithTimestamps(audio, text, timings);
      } else {
        audio.onloadedmetadata = () => {
          const est = estimateTimingsBySentence(text, audio.duration);
          highlightBySentence(audio, est);
          audio.play();
        };
        return;
      }

      audio.play();
    }

    function togglePlayPause(btn) {
      if (audio) {
        if (audio.paused) {
          audio.play();
          btn.innerHTML = `
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
            <span style="display:inline-block; width:88px">T·∫°m d·ª´ng</span>`;
        } else {
          audio.pause();
          btn.innerHTML = `
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <span style="display:inline-block; width:88px">Ti·∫øp t·ª•c</span>`;
        }
      }
    }

    function downloadAudio() {
      if (lastAudioUrl) {
        const link = document.createElement("a");
        link.href = lastAudioUrl;
        link.download = "tts_output.mp3";
        link.click();
      } else {
        alert("‚ùå Kh√¥ng c√≥ file n√†o ƒë·ªÉ t·∫£i.");
      }
    }
  </script>
</body>
</html>
